# نظام التخطيط والمشاريع (10)

> **المصدر:** ملف 18، 19، 20، 21 من المتطلبات التفصيلية
> **الإصدار:** 1.0
> **آخر تحديث:** ديسمبر 2025

---

## 📋 نظرة عامة

نظام التخطيط والمشاريع هو النظام المركزي لإدارة جميع المشاريع الاستراتيجية والتشغيلية، من التخطيط إلى التنفيذ والرقابة.

### الأهداف الرئيسية

1. **التخطيط الاستراتيجي** - تحويل الأهداف إلى مشاريع قابلة للتنفيذ
2. **تجزئة العمل (WBS)** - تقسيم المشاريع إلى خطط وحزم عمل
3. **إدارة التعاقدات** - إسناد حزم العمل للمقاولين
4. **الرقابة المالية** - تتبع الميزانية والمصروفات
5. **الرقابة الزمنية** - مخطط جانت والمسار الحرج
6. **متابعة التنفيذ** - ربط مع العمليات الميدانية

---

## 🔗 الروابط مع الأنظمة الأخرى

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        نظام التخطيط والمشاريع (10)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │  المشاريع   │───▶│   الخطط     │───▶│  حزم العمل  │───▶│  التعاقدات  │  │
│  │  Projects   │    │   Phases    │    │Work Packages│    │  Contracts  │  │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘  │
│         │                  │                  │                  │         │
└─────────┼──────────────────┼──────────────────┼──────────────────┼─────────┘
          │                  │                  │                  │
          ▼                  ▼                  ▼                  ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ 01 - النظام الأم│  │ 04 - العمليات  │  │ 06 - المخزون   │  │ 03 - الأصول    │
│ ─────────────── │  │ ─────────────── │  │ ─────────────── │  │ ─────────────── │
│ • أوامر الدفع   │  │ • أوامر العمل   │  │ • طلبات الصرف  │  │ • الأصول الجديدة│
│ • القيود المحاسبية│  │ • تنفيذ الحزم   │  │ • المواد       │  │ • التركيب      │
│ • الموافقات     │  │ • الفحص والجودة │  │ • المشتريات    │  │ • الصيانة      │
└─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘
          │                  │                  │                  │
          ▼                  ▼                  ▼                  ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│ 07 - العملاء   │  │ 08 - الموارد   │  │ 09 - التقارير  │  │ 05 - المراقبة  │
│ ─────────────── │  │ ─────────────── │  │ ─────────────── │  │ ─────────────── │
│ • ترحيل العملاء │  │ • تخصيص الفنيين │  │ • تقارير التقدم │  │ • مراقبة الأصول│
│ • التركيبات    │  │ • ساعات العمل   │  │ • تقارير مالية  │  │ • الإنذارات    │
└─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘
```

---

## 📊 الهيكل الهرمي للمشاريع

```
مشروع (Project)
│
├── خطة مرحلية 1 (Phase)
│   ├── حزمة عمل 1.1 (Work Package)
│   │   ├── أمر عمل 1.1.1 (Work Order) ──▶ نظام العمليات (04)
│   │   ├── أمر عمل 1.1.2
│   │   └── أمر عمل 1.1.3
│   ├── حزمة عمل 1.2
│   └── حزمة عمل 1.3
│
├── خطة مرحلية 2 (Phase)
│   ├── حزمة عمل 2.1
│   └── حزمة عمل 2.2
│
└── خطة مرحلية 3 (Phase)
    └── حزمة عمل 3.1
```

---

## 1. إدارة المشاريع

### 1.1 جدول المشاريع (projects)

```sql
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    business_id UUID REFERENCES businesses(id) NOT NULL,
    station_id UUID REFERENCES stations(id),
    
    -- معلومات المشروع
    project_number VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    project_type VARCHAR(50) NOT NULL,
    -- 'infrastructure': بنية تحتية
    -- 'expansion': توسعة
    -- 'maintenance': صيانة كبرى
    -- 'migration': ترحيل
    -- 'solar': طاقة شمسية
    -- 'network': شبكات
    -- 'other': أخرى
    
    -- الأهداف
    objectives TEXT,
    scope TEXT,
    deliverables TEXT,
    
    -- الميزانية
    estimated_budget DECIMAL(14, 2) NOT NULL,
    approved_budget DECIMAL(14, 2),
    currency VARCHAR(3) DEFAULT 'SAR',
    
    -- الجدول الزمني
    planned_start_date DATE NOT NULL,
    planned_end_date DATE NOT NULL,
    actual_start_date DATE,
    actual_end_date DATE,
    duration_days INTEGER,
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'draft',
    -- 'draft': مسودة
    -- 'pending_approval': بانتظار الموافقة
    -- 'approved': معتمد
    -- 'in_progress': قيد التنفيذ
    -- 'on_hold': متوقف
    -- 'completed': مكتمل
    -- 'cancelled': ملغي
    
    -- التقدم
    progress_percent DECIMAL(5, 2) DEFAULT 0,
    
    -- المسؤولون
    project_manager_id UUID REFERENCES users(id),
    sponsor_id UUID REFERENCES users(id),
    
    -- الموافقات
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    
    -- المرفقات
    attachments JSONB DEFAULT '[]',
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- فهارس
CREATE INDEX idx_projects_business ON projects(business_id);
CREATE INDEX idx_projects_station ON projects(station_id);
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_type ON projects(project_type);
CREATE INDEX idx_projects_manager ON projects(project_manager_id);
```

### 1.2 جدول أعضاء فريق المشروع (project_team_members)

```sql
CREATE TABLE project_team_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) NOT NULL,
    user_id UUID REFERENCES users(id) NOT NULL,
    
    role VARCHAR(50) NOT NULL,
    -- 'manager': مدير المشروع
    -- 'coordinator': منسق
    -- 'supervisor': مشرف
    -- 'engineer': مهندس
    -- 'technician': فني
    -- 'inspector': فاحص
    
    responsibilities TEXT,
    
    start_date DATE,
    end_date DATE,
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(project_id, user_id)
);
```

---

## 2. الخطط المرحلية (Phases)

### 2.1 جدول الخطط (project_phases)

```sql
CREATE TABLE project_phases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) NOT NULL,
    
    phase_number INTEGER NOT NULL,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    
    -- الميزانية
    allocated_budget DECIMAL(14, 2),
    spent_amount DECIMAL(14, 2) DEFAULT 0,
    
    -- الجدول الزمني
    planned_start_date DATE NOT NULL,
    planned_end_date DATE NOT NULL,
    actual_start_date DATE,
    actual_end_date DATE,
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'pending',
    progress_percent DECIMAL(5, 2) DEFAULT 0,
    
    -- الترتيب
    sequence_order INTEGER DEFAULT 1,
    
    -- التبعيات
    depends_on_phase_id UUID REFERENCES project_phases(id),
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(project_id, phase_number)
);
```

---

## 3. حزم العمل (Work Packages)

### 3.1 جدول حزم العمل (work_packages)

```sql
CREATE TABLE work_packages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    phase_id UUID REFERENCES project_phases(id) NOT NULL,
    project_id UUID REFERENCES projects(id) NOT NULL,
    
    package_number VARCHAR(20) NOT NULL,
    name VARCHAR(200) NOT NULL,
    description TEXT,
    
    -- نطاق العمل
    scope_of_work TEXT,
    deliverables TEXT,
    acceptance_criteria TEXT,
    
    -- التكلفة
    estimated_cost DECIMAL(14, 2),
    contracted_amount DECIMAL(14, 2),
    actual_cost DECIMAL(14, 2) DEFAULT 0,
    
    -- الجدول الزمني
    planned_start_date DATE,
    planned_end_date DATE,
    actual_start_date DATE,
    actual_end_date DATE,
    duration_days INTEGER,
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'draft',
    -- 'draft': مسودة
    -- 'pending_assignment': بانتظار الإسناد
    -- 'assigned': مُسندة
    -- 'in_progress': قيد التنفيذ
    -- 'pending_inspection': بانتظار الفحص
    -- 'inspection_failed': فشل الفحص
    -- 'pending_approval': بانتظار الموافقة
    -- 'approved': موافق عليها
    -- 'completed': مكتملة
    -- 'cancelled': ملغاة
    
    progress_percent DECIMAL(5, 2) DEFAULT 0,
    
    -- المقاول
    contractor_id UUID REFERENCES contractors(id),
    contract_id UUID REFERENCES contracts(id),
    
    -- المشرف
    supervisor_id UUID REFERENCES users(id),
    
    -- الفحص
    inspector_id UUID REFERENCES users(id),
    inspection_date DATE,
    inspection_result VARCHAR(20),
    inspection_notes TEXT,
    
    -- الموافقة والدفع
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    payment_order_id UUID, -- يُملأ عند إنشاء أمر الدفع
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- فهارس
CREATE INDEX idx_work_packages_phase ON work_packages(phase_id);
CREATE INDEX idx_work_packages_project ON work_packages(project_id);
CREATE INDEX idx_work_packages_status ON work_packages(status);
CREATE INDEX idx_work_packages_contractor ON work_packages(contractor_id);
```

### 3.2 جدول مواد حزمة العمل (work_package_materials)

```sql
CREATE TABLE work_package_materials (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    work_package_id UUID REFERENCES work_packages(id) NOT NULL,
    
    item_id UUID REFERENCES items(id) NOT NULL,
    item_code VARCHAR(50),
    item_name VARCHAR(200),
    
    required_quantity DECIMAL(15, 3) NOT NULL,
    issued_quantity DECIMAL(15, 3) DEFAULT 0,
    used_quantity DECIMAL(15, 3) DEFAULT 0,
    returned_quantity DECIMAL(15, 3) DEFAULT 0,
    
    unit_cost DECIMAL(15, 2),
    total_cost DECIMAL(15, 2),
    
    -- ربط مع المخزون
    stock_issue_id UUID, -- إشعار الصرف من نظام المخزون (06)
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 4. إدارة المقاولين والتعاقدات

### 4.1 جدول المقاولين (contractors)

```sql
CREATE TABLE contractors (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    business_id UUID REFERENCES businesses(id) NOT NULL,
    
    contractor_code VARCHAR(20) UNIQUE NOT NULL,
    name VARCHAR(200) NOT NULL,
    name_en VARCHAR(200),
    
    -- معلومات الاتصال
    contact_person VARCHAR(100),
    phone VARCHAR(20),
    email VARCHAR(100),
    address TEXT,
    
    -- التصنيف
    contractor_type VARCHAR(50),
    -- 'individual': فرد
    -- 'company': شركة
    -- 'team': فريق عمل
    
    specializations JSONB DEFAULT '[]',
    -- ['electrical', 'civil', 'solar', 'network']
    
    -- التراخيص
    license_number VARCHAR(50),
    license_expiry DATE,
    
    -- التقييم
    rating DECIMAL(3, 2) DEFAULT 0,
    total_projects INTEGER DEFAULT 0,
    completed_projects INTEGER DEFAULT 0,
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'active',
    
    -- المالية
    bank_name VARCHAR(100),
    bank_account VARCHAR(50),
    iban VARCHAR(34),
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 4.2 جدول العقود (contracts)

```sql
CREATE TABLE contracts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    business_id UUID REFERENCES businesses(id) NOT NULL,
    
    contract_number VARCHAR(30) UNIQUE NOT NULL,
    contractor_id UUID REFERENCES contractors(id) NOT NULL,
    project_id UUID REFERENCES projects(id),
    
    -- نوع العقد
    contract_type VARCHAR(50) NOT NULL,
    -- 'fixed_price': سعر ثابت
    -- 'unit_rate': أسعار وحدات
    -- 'time_material': وقت ومواد
    -- 'framework': إطاري
    
    -- القيمة
    contract_value DECIMAL(14, 2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'SAR',
    
    -- المدة
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    
    -- الشروط
    terms_and_conditions TEXT,
    payment_terms TEXT,
    warranty_period INTEGER, -- بالأشهر
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'draft',
    -- 'draft': مسودة
    -- 'pending_approval': بانتظار الموافقة
    -- 'active': نشط
    -- 'completed': مكتمل
    -- 'terminated': منتهي
    -- 'suspended': معلق
    
    -- الموافقات
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    
    -- المرفقات
    attachments JSONB DEFAULT '[]',
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 4.3 جدول أسعار العقد (contract_rates)

```sql
CREATE TABLE contract_rates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    contract_id UUID REFERENCES contracts(id) NOT NULL,
    
    service_code VARCHAR(50) NOT NULL,
    service_name VARCHAR(200) NOT NULL,
    description TEXT,
    
    unit VARCHAR(20) NOT NULL,
    unit_rate DECIMAL(15, 2) NOT NULL,
    
    -- الحدود
    min_quantity DECIMAL(15, 3),
    max_quantity DECIMAL(15, 3),
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 5. الرقابة المالية

### 5.1 جدول ميزانية المشروع (project_budgets)

```sql
CREATE TABLE project_budgets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) NOT NULL,
    
    budget_version INTEGER DEFAULT 1,
    
    -- الميزانية الأصلية
    original_budget DECIMAL(14, 2) NOT NULL,
    
    -- التعديلات
    adjustments DECIMAL(14, 2) DEFAULT 0,
    current_budget DECIMAL(14, 2) NOT NULL,
    
    -- الالتزامات
    committed_amount DECIMAL(14, 2) DEFAULT 0, -- المبالغ المتعاقد عليها
    
    -- المصروفات
    spent_amount DECIMAL(14, 2) DEFAULT 0,
    
    -- المتبقي
    remaining_budget DECIMAL(14, 2),
    
    -- النسب
    commitment_percent DECIMAL(5, 2) DEFAULT 0,
    spent_percent DECIMAL(5, 2) DEFAULT 0,
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'active',
    
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(project_id, budget_version)
);
```

### 5.2 جدول توزيع الميزانية (budget_allocations)

```sql
CREATE TABLE budget_allocations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    budget_id UUID REFERENCES project_budgets(id) NOT NULL,
    
    -- التوزيع
    allocation_type VARCHAR(50) NOT NULL,
    -- 'phase': خطة مرحلية
    -- 'category': فئة تكلفة
    -- 'contractor': مقاول
    
    reference_id UUID,
    reference_name VARCHAR(200),
    
    allocated_amount DECIMAL(14, 2) NOT NULL,
    spent_amount DECIMAL(14, 2) DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 5.3 جدول مصروفات المشروع (project_expenses)

```sql
CREATE TABLE project_expenses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) NOT NULL,
    phase_id UUID REFERENCES project_phases(id),
    work_package_id UUID REFERENCES work_packages(id),
    
    expense_type VARCHAR(50) NOT NULL,
    -- 'contractor_payment': دفعة مقاول
    -- 'material': مواد
    -- 'labor': عمالة
    -- 'equipment': معدات
    -- 'other': أخرى
    
    description TEXT,
    amount DECIMAL(14, 2) NOT NULL,
    
    -- المرجع
    reference_type VARCHAR(50),
    reference_id UUID,
    
    expense_date DATE NOT NULL,
    
    -- الربط المحاسبي
    journal_entry_id UUID, -- من النظام الأم (01)
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 6. الرقابة الزمنية ومخطط جانت

### 6.1 جدول التبعيات بين المهام (task_dependencies)

```sql
CREATE TABLE task_dependencies (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- المهمة التابعة
    task_id UUID NOT NULL,
    task_type VARCHAR(50) NOT NULL, -- 'project', 'phase', 'work_package'
    
    -- المهمة المعتمد عليها
    depends_on_id UUID NOT NULL,
    depends_on_type VARCHAR(50) NOT NULL,
    
    -- نوع التبعية
    dependency_type VARCHAR(20) DEFAULT 'finish_to_start',
    -- 'finish_to_start': FS - لا تبدأ حتى تنتهي السابقة
    -- 'start_to_start': SS - تبدأ مع بداية السابقة
    -- 'finish_to_finish': FF - تنتهي مع نهاية السابقة
    -- 'start_to_finish': SF - تنتهي مع بداية السابقة
    
    -- فترة التأخير (بالأيام)
    lag_days INTEGER DEFAULT 0,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### 6.2 جدول المعالم (project_milestones)

```sql
CREATE TABLE project_milestones (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) NOT NULL,
    
    name VARCHAR(200) NOT NULL,
    description TEXT,
    
    -- التاريخ
    planned_date DATE NOT NULL,
    actual_date DATE,
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'pending',
    -- 'pending': قادم
    -- 'achieved': تم تحقيقه
    -- 'delayed': متأخر
    -- 'at_risk': معرض للخطر
    
    -- الربط
    linked_task_id UUID,
    linked_task_type VARCHAR(50),
    
    is_critical BOOLEAN DEFAULT false,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 6.3 جدول المسار الحرج (critical_path_cache)

```sql
CREATE TABLE critical_path_cache (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) NOT NULL,
    
    -- المهام في المسار الحرج
    critical_tasks JSONB NOT NULL,
    
    -- حسابات المسار
    total_duration INTEGER,
    earliest_finish DATE,
    latest_finish DATE,
    
    calculated_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(project_id)
);
```

### 6.4 جدول خط الأساس (project_baselines)

```sql
CREATE TABLE project_baselines (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) NOT NULL,
    
    baseline_number INTEGER DEFAULT 1,
    name VARCHAR(100),
    description TEXT,
    
    -- لقطة البيانات
    baseline_data JSONB NOT NULL,
    -- يحتوي على: المهام، التواريخ، الميزانية
    
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    
    UNIQUE(project_id, baseline_number)
);
```

---

## 7. 💻 الشاشات والواجهات

### 7.1 شاشة إنشاء المشروع

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 📁 إنشاء مشروع جديد                                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─ المعلومات الأساسية ─────────────────────────────────────────────────────┐  │
│  │ اسم المشروع: [محطة الطاقة الشمسية - المنطقة الشرقية                    ] │  │
│  │ نوع المشروع: [طاقة شمسية              ▼]                                 │  │
│  │ المحطة: [المحطة الرئيسية              ▼]                                 │  │
│  │ مدير المشروع: [م. أحمد محمد           ▼]                                 │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌─ الأهداف والنطاق ─────────────────────────────────────────────────────────┐  │
│  │ الأهداف:                                                                  │  │
│  │ [إنشاء محطة طاقة شمسية بقدرة 1 ميجاوات لتغذية الشبكة                   ] │  │
│  │                                                                           │  │
│  │ نطاق العمل:                                                               │  │
│  │ [تجهيز الموقع، تركيب الألواح، التوصيلات، الربط بالشبكة                 ] │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌─ الميزانية والجدول الزمني ────────────────────────────────────────────────┐  │
│  │ الميزانية التقديرية: [5,000,000        ] ريال                            │  │
│  │ تاريخ البدء: [15/12/2025]    تاريخ الانتهاء: [30/06/2026]                │  │
│  │ المدة: 28 أسبوع                                                          │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  [حفظ كمسودة]  [إرسال للموافقة]  [إلغاء]                                       │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 شاشة تجزئة العمل (WBS)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 🔧 تجزئة العمل - مشروع محطة الطاقة الشمسية                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  [+ إضافة خطة]  [+ إضافة حزمة]  [📥 استيراد قالب]  [💾 حفظ]                    │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │ 📁 المشروع: محطة الطاقة الشمسية                                           ││
│  │ │                                                                          ││
│  │ ├─📂 خطة 1: تجهيز الموقع (500,000 ريال)                                   ││
│  │ │  ├─📦 1.1 تسوية الأرض ────────────── 50,000 ريال ── 5 أيام             ││
│  │ │  ├─📦 1.2 بناء الأساسات ──────────── 200,000 ريال ── 15 يوم            ││
│  │ │  └─📦 1.3 غرفة التحكم ────────────── 250,000 ريال ── 20 يوم            ││
│  │ │                                                                          ││
│  │ ├─📂 خطة 2: الهياكل والألواح (1,500,000 ريال)                             ││
│  │ │  ├─📦 2.1 القواعد الحديدية ────────── 400,000 ريال ── 10 أيام           ││
│  │ │  └─📦 2.2 تركيب الألواح ──────────── 1,100,000 ريال ── 25 يوم          ││
│  │ │                                                                          ││
│  │ ├─📂 خطة 3: التوصيلات DC (1,000,000 ريال)                                 ││
│  │ │  ├─📦 3.1 التسليك ────────────────── 600,000 ريال ── 15 يوم            ││
│  │ │  └─📦 3.2 أنظمة الحماية ──────────── 400,000 ريال ── 10 أيام           ││
│  │ │                                                                          ││
│  │ ├─📂 خطة 4: الإنفرترات (1,200,000 ريال)                                   ││
│  │ │  └─📦 4.1 تركيب وبرمجة ──────────── 1,200,000 ريال ── 20 يوم           ││
│  │ │                                                                          ││
│  │ └─📂 خطة 5: التشغيل والربط (800,000 ريال)                                 ││
│  │    ├─📦 5.1 الاختبارات ─────────────── 300,000 ريال ── 10 أيام           ││
│  │    └─📦 5.2 الربط بالشبكة ──────────── 500,000 ريال ── 5 أيام            ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                                                                 │
│  ملخص: 5 خطط | 10 حزم عمل | 5,000,000 ريال | 135 يوم                          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 شاشة مخطط جانت التفاعلي

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 📊 مخطط جانت - مشروع محطة الطاقة الشمسية                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│ [اليوم] [الأسبوع] [الشهر] [الربع]    🔍 بحث    📥 تصدير    ⚙️ إعدادات         │
│                                                                                 │
│ ┌─────────────────────────────────────────────────────────────────────────────┐ │
│ │ المهمة                    │ ديسمبر 2025      │ يناير 2026       │ فبراير   │ │
│ │                           │ 15 22 29         │ 5  12 19 26      │ 2  9  16 │ │
│ ├───────────────────────────┼──────────────────┼──────────────────┼──────────┤ │
│ │ 📁 خطة 1: تجهيز الموقع   │                  │                  │          │ │
│ │   ├─ تسوية الأرض         │ ████████         │                  │          │ │
│ │   ├─ بناء الأساسات       │      ░░░░████████│                  │          │ │
│ │   └─ غرفة التحكم         │                  │████████          │          │ │
│ │                           │                  │                  │          │ │
│ │ 📁 خطة 2: الهياكل        │                  │                  │          │ │
│ │   ├─ القواعد الحديدية 🔴 │                  │     ████████     │          │ │
│ │   └─ تركيب الألواح 🔴    │                  │          ████████│██████    │ │
│ │                           │                  │                  │          │ │
│ │ ⭐ معلم: اكتمال التركيب  │                  │                  │        ◆ │ │
│ └─────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│ 📌 دليل الألوان:                                                               │
│ ████ مكتمل    ░░░░ مخطط    🔴 مسار حرج    ◆ معلم    ⚠️ متأخر                  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 7.4 لوحة المتابعة المالية

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 💰 لوحة المتابعة المالية - مشروع محطة الطاقة الشمسية                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │ الميزانية       │  │ الالتزامات      │  │ المصروفات       │  │ المتبقي     │ │
│  │ 5,000,000      │  │ 4,200,000      │  │ 2,100,000      │  │ 800,000    │ │
│  │ ريال           │  │ 84%            │  │ 42%            │  │ 16%        │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────┘ │
│                                                                                 │
│  ┌─ توزيع الميزانية على الخطط ──────────────────────────────────────────────┐  │
│  │                                                                           │  │
│  │  خطة 1 ████████████████░░░░░░░░░░░░░░░░░░░░ 500K (100% مصروف)            │  │
│  │  خطة 2 ████████████████████████░░░░░░░░░░░░ 1.5M (60% مصروف)             │  │
│  │  خطة 3 ████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 1M (20% مصروف)               │  │
│  │  خطة 4 ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 1.2M (0% مصروف)              │  │
│  │  خطة 5 ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░ 800K (0% مصروف)              │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌─ آخر الدفعات ─────────────────────────────────────────────────────────────┐  │
│  │ # │ التاريخ  │ المقاول          │ حزمة العمل      │ المبلغ    │ الحالة   │  │
│  │ 1 │ 20/12   │ فريق التسوية     │ 1.1 تسوية الأرض │ 50,000   │ ✅ مدفوع │  │
│  │ 2 │ 05/01   │ شركة البناء      │ 1.2 الأساسات    │ 200,000  │ ✅ مدفوع │  │
│  │ 3 │ 25/01   │ شركة البناء      │ 1.3 غرفة التحكم │ 250,000  │ ⏳ معلق  │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. التكامل مع نظام العمليات الميدانية (04)

### 8.1 إنشاء أوامر العمل من حزم العمل

```
حزمة العمل (10)                    أمر العمل (04)
┌─────────────────┐               ┌─────────────────┐
│ حزمة 2.2        │               │ أمر عمل #1234   │
│ تركيب الألواح   │──────────────▶│ تركيب 100 لوح   │
│ 100 لوح شمسي   │               │ الفني: أحمد     │
│ المقاول: فريق أ │               │ الموقع: القطاع 1│
└─────────────────┘               └─────────────────┘
                                          │
                                          ▼
                                  ┌─────────────────┐
                                  │ أمر عمل #1235   │
                                  │ تركيب 100 لوح   │
                                  │ الفني: محمد     │
                                  │ الموقع: القطاع 2│
                                  └─────────────────┘
```

### 8.2 Trigger لتحديث تقدم حزمة العمل

```sql
CREATE OR REPLACE FUNCTION update_work_package_progress()
RETURNS TRIGGER AS $$
DECLARE
    v_total_orders INTEGER;
    v_completed_orders INTEGER;
    v_progress DECIMAL(5,2);
BEGIN
    -- حساب عدد أوامر العمل المرتبطة
    SELECT 
        COUNT(*),
        COUNT(*) FILTER (WHERE status = 'completed')
    INTO v_total_orders, v_completed_orders
    FROM field_operations
    WHERE work_package_id = NEW.work_package_id;
    
    -- حساب نسبة التقدم
    IF v_total_orders > 0 THEN
        v_progress := (v_completed_orders::DECIMAL / v_total_orders) * 100;
    ELSE
        v_progress := 0;
    END IF;
    
    -- تحديث حزمة العمل
    UPDATE work_packages
    SET 
        progress_percent = v_progress,
        status = CASE 
            WHEN v_progress = 100 THEN 'pending_inspection'
            WHEN v_progress > 0 THEN 'in_progress'
            ELSE status
        END,
        updated_at = NOW()
    WHERE id = NEW.work_package_id;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_work_package_progress
AFTER UPDATE OF status ON field_operations
FOR EACH ROW
WHEN (NEW.work_package_id IS NOT NULL)
EXECUTE FUNCTION update_work_package_progress();
```

---

## 9. التكامل مع النظام الأم (01) - أوامر الدفع

### 9.1 إنشاء أمر دفع عند الموافقة على حزمة العمل

```sql
CREATE OR REPLACE FUNCTION create_payment_order_on_approval()
RETURNS TRIGGER AS $$
DECLARE
    v_payment_order_id UUID;
    v_contractor RECORD;
BEGIN
    -- فقط عند الانتقال لحالة "approved"
    IF NEW.status = 'approved' AND OLD.status = 'pending_approval' THEN
        
        -- جلب بيانات المقاول
        SELECT * INTO v_contractor
        FROM contractors
        WHERE id = NEW.contractor_id;
        
        -- إنشاء أمر الدفع
        INSERT INTO payment_orders (
            business_id,
            order_number,
            order_type,
            beneficiary_type,
            beneficiary_id,
            beneficiary_name,
            amount,
            description,
            reference_type,
            reference_id,
            bank_name,
            bank_account,
            iban,
            status,
            created_at
        ) VALUES (
            (SELECT business_id FROM projects WHERE id = NEW.project_id),
            generate_payment_order_number(),
            'contractor_payment',
            'contractor',
            NEW.contractor_id,
            v_contractor.name,
            NEW.contracted_amount,
            'دفعة حزمة عمل: ' || NEW.name,
            'work_package',
            NEW.id,
            v_contractor.bank_name,
            v_contractor.bank_account,
            v_contractor.iban,
            'pending',
            NOW()
        ) RETURNING id INTO v_payment_order_id;
        
        -- تحديث حزمة العمل بمعرف أمر الدفع
        NEW.payment_order_id := v_payment_order_id;
        
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_create_payment_order
BEFORE UPDATE ON work_packages
FOR EACH ROW
EXECUTE FUNCTION create_payment_order_on_approval();
```

---

## 10. التكامل مع نظام المخزون (06)

### 10.1 طلب مواد لحزمة العمل

```sql
-- عند إنشاء طلب صرف مواد لحزمة عمل
CREATE OR REPLACE FUNCTION link_stock_issue_to_project()
RETURNS TRIGGER AS $$
BEGIN
    -- إذا كان الصرف مرتبط بحزمة عمل
    IF NEW.work_package_id IS NOT NULL THEN
        -- تحديث تكلفة المواد في حزمة العمل
        UPDATE work_packages
        SET actual_cost = actual_cost + NEW.total_cost
        WHERE id = NEW.work_package_id;
        
        -- تسجيل المصروف في المشروع
        INSERT INTO project_expenses (
            project_id,
            phase_id,
            work_package_id,
            expense_type,
            description,
            amount,
            reference_type,
            reference_id,
            expense_date
        )
        SELECT 
            wp.project_id,
            wp.phase_id,
            wp.id,
            'material',
            'صرف مواد: ' || NEW.issue_number,
            NEW.total_cost,
            'stock_issue',
            NEW.id,
            CURRENT_DATE
        FROM work_packages wp
        WHERE wp.id = NEW.work_package_id;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## 11. التكامل مع نظام الأصول (03)

### 11.1 تسجيل الأصول المركبة في المشروع

```sql
-- عند تركيب أصل جديد ضمن مشروع
CREATE OR REPLACE FUNCTION link_asset_to_project()
RETURNS TRIGGER AS $$
BEGIN
    -- إذا كان التركيب ضمن حزمة عمل
    IF NEW.work_package_id IS NOT NULL THEN
        -- تحديث الأصل بمعلومات المشروع
        UPDATE assets
        SET 
            project_id = (SELECT project_id FROM work_packages WHERE id = NEW.work_package_id),
            installation_work_package_id = NEW.work_package_id,
            installation_date = CURRENT_DATE
        WHERE id = NEW.asset_id;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

---

## 12. APIs نظام التخطيط والمشاريع

### 12.1 APIs المشاريع

| Method | Endpoint | الوصف |
|--------|----------|-------|
| GET | `/api/v1/projects` | قائمة المشاريع |
| POST | `/api/v1/projects` | إنشاء مشروع |
| GET | `/api/v1/projects/:id` | تفاصيل مشروع |
| PUT | `/api/v1/projects/:id` | تحديث مشروع |
| DELETE | `/api/v1/projects/:id` | حذف مشروع |
| POST | `/api/v1/projects/:id/approve` | الموافقة على مشروع |
| GET | `/api/v1/projects/:id/dashboard` | لوحة تحكم المشروع |
| GET | `/api/v1/projects/:id/team` | فريق المشروع |

### 12.2 APIs الخطط

| Method | Endpoint | الوصف |
|--------|----------|-------|
| GET | `/api/v1/projects/:id/phases` | خطط المشروع |
| POST | `/api/v1/phases` | إنشاء خطة |
| PUT | `/api/v1/phases/:id` | تحديث خطة |
| DELETE | `/api/v1/phases/:id` | حذف خطة |

### 12.3 APIs حزم العمل

| Method | Endpoint | الوصف |
|--------|----------|-------|
| GET | `/api/v1/phases/:id/work-packages` | حزم عمل الخطة |
| POST | `/api/v1/work-packages` | إنشاء حزمة عمل |
| PUT | `/api/v1/work-packages/:id` | تحديث حزمة عمل |
| POST | `/api/v1/work-packages/:id/assign` | إسناد لمقاول |
| POST | `/api/v1/work-packages/:id/submit-inspection` | تقديم للفحص |
| POST | `/api/v1/work-packages/:id/approve` | الموافقة |
| GET | `/api/v1/work-packages/:id/work-orders` | أوامر العمل |

### 12.4 APIs مخطط جانت

| Method | Endpoint | الوصف |
|--------|----------|-------|
| GET | `/api/v1/projects/:id/gantt` | بيانات مخطط جانت |
| GET | `/api/v1/projects/:id/critical-path` | المسار الحرج |
| POST | `/api/v1/projects/:id/critical-path/calculate` | إعادة حساب |
| GET | `/api/v1/projects/:id/milestones` | المعالم |
| POST | `/api/v1/task-dependencies` | إنشاء تبعية |

### 12.5 APIs الميزانية

| Method | Endpoint | الوصف |
|--------|----------|-------|
| GET | `/api/v1/projects/:id/budget` | ميزانية المشروع |
| POST | `/api/v1/projects/:id/budget/allocate` | توزيع الميزانية |
| GET | `/api/v1/projects/:id/expenses` | مصروفات المشروع |
| GET | `/api/v1/projects/:id/financial-dashboard` | لوحة المتابعة المالية |

### 12.6 APIs المقاولين

| Method | Endpoint | الوصف |
|--------|----------|-------|
| GET | `/api/v1/contractors` | قائمة المقاولين |
| POST | `/api/v1/contractors` | إنشاء مقاول |
| GET | `/api/v1/contractors/:id` | تفاصيل مقاول |
| GET | `/api/v1/contractors/:id/contracts` | عقود المقاول |
| GET | `/api/v1/contractors/:id/work-packages` | حزم عمل المقاول |

---

## 13. التقارير (ترسل لنظام التقارير 09)

| التقرير | الوصف |
|---------|-------|
| تقرير حالة المشاريع | ملخص جميع المشاريع |
| تقرير تقدم المشروع | التقدم الزمني والمالي |
| تقرير المسار الحرج | المهام الحرجة |
| تقرير الانحراف الزمني | مقارنة المخطط بالفعلي |
| تقرير الميزانية | الالتزامات والمصروفات |
| تقرير أداء المقاولين | تقييم المقاولين |
| تقرير حزم العمل | حالة الحزم |

---

# 12. معالج إغلاق المشروع (Project Closure Wizard)

> **الغرض:** إغلاق المشروع بشكل منظم مع تصفية جميع العهد ورسملة الأصول المنشأة

## 12.1 خطوات إغلاق المشروع

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        معالج إغلاق المشروع                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐    ┌─────┐           │
│  │  1  │───▶│  2  │───▶│  3  │───▶│  4  │───▶│  5  │───▶│  6  │           │
│  └──┬──┘    └──┬──┘    └──┬──┘    └──┬──┘    └──┬──┘    └──┬──┘           │
│     │          │          │          │          │          │               │
│  التحقق    تصفية      تصفية     رسملة      القيود     الإغلاق            │
│  الأولي    العهد      العهد     الأصول    المحاسبية   النهائي            │
│           المادية    المالية                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 12.2 الخطوة 1: التحقق الأولي

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 📋 إغلاق المشروع - الخطوة 1: التحقق الأولي                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  المشروع: PRJ-2025-001 - مشروع تمديد شبكة الفيبر                               │
│                                                                                 │
│  ┌─ قائمة التحقق ────────────────────────────────────────────────────────────┐  │
│  │                                                                           │  │
│  │ ✅ جميع حزم العمل مكتملة (15/15)                                         │  │
│  │ ✅ جميع أوامر العمل مغلقة (45/45)                                        │  │
│  │ ✅ جميع الفحوصات موافق عليها (45/45)                                     │  │
│  │ ⚠️ عهد مادية مفتوحة: 3 عهد                                               │  │
│  │ ⚠️ عهد مالية مفتوحة: 1 عهدة                                              │  │
│  │ ✅ لا توجد فواتير موردين معلقة                                           │  │
│  │ ✅ جميع الدفعات للمقاولين تمت                                            │  │
│  │                                                                           │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌─ ملخص المشروع ────────────────────────────────────────────────────────────┐  │
│  │ الميزانية المعتمدة: 500,000 ريال                                          │  │
│  │ المصروف الفعلي: 485,000 ريال                                              │  │
│  │ الفرق: 15,000 ريال (وفر)                                                  │  │
│  │                                                                           │  │
│  │ تاريخ البدء: 01/01/2025                                                   │  │
│  │ تاريخ الانتهاء المخطط: 30/06/2025                                         │  │
│  │ تاريخ الانتهاء الفعلي: 15/06/2025 (مبكر 15 يوم)                          │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  [التالي: تصفية العهد المادية →]                                               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 12.3 الخطوة 2: تصفية العهد المادية

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 📦 إغلاق المشروع - الخطوة 2: تصفية العهد المادية                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─ العهد المادية المفتوحة ──────────────────────────────────────────────────┐  │
│  │                                                                           │  │
│  │ # │ رقم العهدة │ المستلم        │ القيمة    │ المتبقي   │ الإجراء        │  │
│  │ 1 │ CUS-001   │ فريق الشرق    │ 50,000   │ 5,000    │ [تصفية]        │  │
│  │ 2 │ CUS-002   │ فريق الغرب    │ 45,000   │ 3,000    │ [تصفية]        │  │
│  │ 3 │ CUS-003   │ أحمد الفني    │ 10,000   │ 1,500    │ [تصفية]        │  │
│  │                                                                           │  │
│  │ إجمالي المتبقي: 9,500 ريال                                                │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌─ تصفية سريعة ─────────────────────────────────────────────────────────────┐  │
│  │ [✓] تصفية جميع العهد كمستهلكة                                            │  │
│  │ [ ] إرجاع المتبقي للمخزن                                                  │  │
│  │ [ ] تحويل للمشروع التالي                                                  │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  [← السابق]  [التالي: تصفية العهد المالية →]                                   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 12.4 الخطوة 4: رسملة الأصول

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 🏗️ إغلاق المشروع - الخطوة 4: رسملة الأصول                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─ الأصول المنشأة من المشروع ───────────────────────────────────────────────┐  │
│  │                                                                           │  │
│  │ # │ الوصف                    │ الفئة      │ التكلفة    │ العمر │ الإهلاك  │  │
│  │ 1 │ شبكة فيبر - المنطقة أ   │ شبكات     │ 200,000   │ 15 سنة│ قسط ثابت │  │
│  │ 2 │ شبكة فيبر - المنطقة ب   │ شبكات     │ 180,000   │ 15 سنة│ قسط ثابت │  │
│  │ 3 │ محطة توزيع رئيسية       │ محطات     │ 80,000    │ 20 سنة│ قسط ثابت │  │
│  │ 4 │ معدات قياس وفحص         │ معدات     │ 25,000    │ 5 سنة │ قسط ثابت │  │
│  │                                                                           │  │
│  │ إجمالي الأصول: 485,000 ريال                                               │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌─ إعدادات الرسملة ─────────────────────────────────────────────────────────┐  │
│  │ تاريخ الرسملة: [15/06/2025] (تاريخ الإنجاز)                               │  │
│  │ بدء الإهلاك من: [01/07/2025]                                              │  │
│  │                                                                           │  │
│  │ [✓] إنشاء سجلات الأصول تلقائياً في نظام الأصول                           │  │
│  │ [✓] إنشاء جداول الإهلاك                                                   │  │
│  │ [✓] إنشاء قيد الرسملة                                                     │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  [← السابق]  [التالي: القيود المحاسبية →]                                      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 12.5 جدول إغلاق المشاريع (project_closures)

```sql
CREATE TABLE project_closures (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) NOT NULL,
    
    -- رقم الإغلاق
    closure_number VARCHAR(20) UNIQUE NOT NULL,
    
    -- التواريخ
    closure_date DATE NOT NULL DEFAULT CURRENT_DATE,
    capitalization_date DATE,
    depreciation_start_date DATE,
    
    -- الملخص المالي
    approved_budget DECIMAL(15, 2),
    actual_cost DECIMAL(15, 2),
    variance DECIMAL(15, 2),
    variance_percentage DECIMAL(5, 2),
    
    -- الملخص الزمني
    planned_start_date DATE,
    planned_end_date DATE,
    actual_start_date DATE,
    actual_end_date DATE,
    schedule_variance_days INTEGER,
    
    -- العهد
    material_custodies_settled INTEGER DEFAULT 0,
    financial_custodies_settled INTEGER DEFAULT 0,
    total_custody_value_settled DECIMAL(15, 2) DEFAULT 0,
    
    -- الأصول
    assets_created INTEGER DEFAULT 0,
    total_assets_value DECIMAL(15, 2) DEFAULT 0,
    
    -- القيود
    capitalization_journal_entry_id UUID,
    closure_journal_entry_id UUID,
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'in_progress',
    -- 'in_progress': جاري الإغلاق
    -- 'pending_approval': بانتظار الموافقة
    -- 'approved': موافق عليه
    -- 'completed': مكتمل
    
    -- الموافقات
    prepared_by UUID REFERENCES users(id),
    reviewed_by UUID REFERENCES users(id),
    approved_by UUID REFERENCES users(id),
    approved_at TIMESTAMP,
    
    -- الملاحظات
    lessons_learned TEXT,
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

## 12.6 جدول أصول المشروع (project_assets)

```sql
CREATE TABLE project_assets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    closure_id UUID REFERENCES project_closures(id) NOT NULL,
    project_id UUID REFERENCES projects(id) NOT NULL,
    
    -- وصف الأصل
    asset_name VARCHAR(200) NOT NULL,
    asset_description TEXT,
    
    -- التصنيف
    asset_category_id UUID REFERENCES asset_categories(id),
    asset_category_name VARCHAR(100),
    
    -- التكلفة
    acquisition_cost DECIMAL(15, 2) NOT NULL,
    
    -- الإهلاك
    useful_life_years INTEGER,
    depreciation_method VARCHAR(20) DEFAULT 'straight_line',
    salvage_value DECIMAL(15, 2) DEFAULT 0,
    annual_depreciation DECIMAL(15, 2),
    
    -- الموقع
    location_id UUID,
    location_name VARCHAR(200),
    
    -- الأصل المنشأ
    created_asset_id UUID REFERENCES assets(id),
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'pending',
    -- 'pending': بانتظار الرسملة
    -- 'capitalized': تم الرسملة
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

## 12.7 قيد الرسملة

```sql
-- قيد رسملة مشروع (تحويل من مشاريع تحت التنفيذ إلى أصول ثابتة)

-- مدين: الأصول الثابتة (حسب الفئة)
مدين: 1510 - شبكات وخطوط ............... 380,000 ريال
مدين: 1520 - محطات ومباني .............. 80,000 ريال
مدين: 1530 - معدات وأجهزة .............. 25,000 ريال

-- دائن: مشاريع تحت التنفيذ
  دائن: 1600 - مشاريع تحت التنفيذ ....... 485,000 ريال
```

## 12.8 Trigger: إنشاء الأصول عند الرسملة

```sql
CREATE OR REPLACE FUNCTION process_project_capitalization()
RETURNS TRIGGER AS $$
DECLARE
    v_asset_id UUID;
    v_project_asset RECORD;
BEGIN
    -- فقط عند الموافقة على الإغلاق
    IF NEW.status = 'approved' AND OLD.status = 'pending_approval' THEN
        
        -- إنشاء الأصول
        FOR v_project_asset IN 
            SELECT * FROM project_assets WHERE closure_id = NEW.id AND status = 'pending'
        LOOP
            -- إنشاء سجل الأصل في نظام الأصول
            INSERT INTO assets (
                business_id,
                asset_code,
                asset_name,
                description,
                category_id,
                acquisition_date,
                acquisition_cost,
                useful_life_years,
                depreciation_method,
                salvage_value,
                location_id,
                source_type,
                source_id,
                status
            ) VALUES (
                (SELECT business_id FROM projects WHERE id = NEW.project_id),
                generate_asset_code(),
                v_project_asset.asset_name,
                v_project_asset.asset_description,
                v_project_asset.asset_category_id,
                NEW.capitalization_date,
                v_project_asset.acquisition_cost,
                v_project_asset.useful_life_years,
                v_project_asset.depreciation_method,
                v_project_asset.salvage_value,
                v_project_asset.location_id,
                'project',
                NEW.project_id,
                'active'
            ) RETURNING id INTO v_asset_id;
            
            -- تحديث سجل أصل المشروع
            UPDATE project_assets 
            SET created_asset_id = v_asset_id, status = 'capitalized'
            WHERE id = v_project_asset.id;
            
            -- إنشاء جدول الإهلاك
            PERFORM create_depreciation_schedule(v_asset_id);
        END LOOP;
        
        -- إنشاء قيد الرسملة
        PERFORM create_capitalization_journal_entry(NEW.id);
        
        -- تحديث حالة المشروع
        UPDATE projects SET status = 'closed' WHERE id = NEW.project_id;
        
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_project_capitalization
AFTER UPDATE ON project_closures
FOR EACH ROW
EXECUTE FUNCTION process_project_capitalization();
```

## 12.9 APIs إغلاق المشاريع

| Method | Endpoint | الوصف |
|--------|----------|-------|
| POST | `/api/v1/projects/:id/closure/start` | بدء إغلاق المشروع |
| GET | `/api/v1/projects/:id/closure` | حالة الإغلاق |
| GET | `/api/v1/projects/:id/closure/checklist` | قائمة التحقق |
| POST | `/api/v1/projects/:id/closure/settle-custodies` | تصفية العهد |
| POST | `/api/v1/projects/:id/closure/assets` | إضافة أصول للرسملة |
| PUT | `/api/v1/projects/:id/closure/assets/:assetId` | تعديل أصل |
| POST | `/api/v1/projects/:id/closure/submit` | إرسال للموافقة |
| POST | `/api/v1/projects/:id/closure/approve` | الموافقة على الإغلاق |
| GET | `/api/v1/project-closures` | قائمة الإغلاقات |

---

# 11. ربط تكلفة الخدمات بحزم العمل (Service Cost Integration)

> **الغرض:** حساب تكلفة العمالة في حزم العمل بناءً على كتالوج الخدمات المركزي

## 11.1 جدول خدمات حزمة العمل

```sql
CREATE TABLE work_package_services (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    work_package_id UUID REFERENCES work_packages(id) ON DELETE CASCADE,
    service_id UUID REFERENCES service_catalog(id),
    
    -- الكميات
    estimated_quantity INTEGER DEFAULT 1,
    actual_quantity INTEGER DEFAULT 0,
    
    -- التسعير
    unit_price DECIMAL(10, 2),  -- من كتالوج الخدمات
    estimated_cost DECIMAL(12, 2) GENERATED ALWAYS AS (estimated_quantity * unit_price) STORED,
    actual_cost DECIMAL(12, 2) GENERATED ALWAYS AS (actual_quantity * unit_price) STORED,
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'planned',
    -- 'planned': مخطط
    -- 'in_progress': قيد التنفيذ
    -- 'completed': مكتمل
    
    notes TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Trigger لتحديث تكلفة حزمة العمل
CREATE OR REPLACE FUNCTION update_work_package_service_cost()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE work_packages
    SET 
        estimated_labor_cost = (
            SELECT COALESCE(SUM(estimated_cost), 0)
            FROM work_package_services
            WHERE work_package_id = NEW.work_package_id
        ),
        actual_labor_cost = (
            SELECT COALESCE(SUM(actual_cost), 0)
            FROM work_package_services
            WHERE work_package_id = NEW.work_package_id
        ),
        updated_at = NOW()
    WHERE id = NEW.work_package_id;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_update_wp_service_cost
AFTER INSERT OR UPDATE OR DELETE ON work_package_services
FOR EACH ROW EXECUTE FUNCTION update_work_package_service_cost();
```

## 11.2 شاشة تكلفة الخدمات في حزمة العمل

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│ 💰 تكلفة الخدمات - حزمة العمل: WP-2025-001                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  الخدمات المطلوبة:                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │ الخدمة              │ الوحدة │ السعر │ الكمية │ التكلفة │ الفعلي │ الحالة  ││
│  ├─────────────────────┼────────┼───────┼────────┼─────────┼────────┼─────────┤│
│  │ تركيب عداد جديد    │ عداد  │ 150   │ 50     │ 7,500   │ 45     │ قيد     ││
│  │ تمديد كيبل ABC     │ متر   │ 25    │ 500    │ 12,500  │ 480    │ قيد     ││
│  │ تركيب طبلون        │ طبلون │ 500   │ 5      │ 2,500   │ 5      │ مكتمل   ││
│  │ فحص وتشغيل         │ نقطة  │ 100   │ 50     │ 5,000   │ 0      │ مخطط    ││
│  ├─────────────────────┼────────┼───────┼────────┼─────────┼────────┼─────────┤│
│  │ الإجمالي           │        │       │        │ 27,500  │ 24,750 │         ││
│  └─────────────────────┴────────┴───────┴────────┴─────────┴────────┴─────────┘│
│                                                                                 │
│  [+ إضافة خدمة]  [📊 تقرير التكلفة]                                            │
│                                                                                 │
│  ملخص التكلفة:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────┐│
│  │ تكلفة المواد (تقديرية): 150,000 ريال                                       ││
│  │ تكلفة العمالة (تقديرية): 27,500 ريال                                       ││
│  │ ─────────────────────────────────────                                       ││
│  │ إجمالي التكلفة التقديرية: 177,500 ريال                                     ││
│  │                                                                             ││
│  │ تكلفة المواد (فعلية): 145,000 ريال                                         ││
│  │ تكلفة العمالة (فعلية): 24,750 ريال                                         ││
│  │ ─────────────────────────────────────                                       ││
│  │ إجمالي التكلفة الفعلية: 169,750 ريال                                       ││
│  │                                                                             ││
│  │ الفرق: -7,750 ريال (وفر 4.4%)                                              ││
│  └─────────────────────────────────────────────────────────────────────────────┘│
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 11.3 APIs تكلفة الخدمات

| Method | Endpoint | الوصف |
|--------|----------|-------|
| GET | `/api/v1/work-packages/:id/services` | خدمات حزمة العمل |
| POST | `/api/v1/work-packages/:id/services` | إضافة خدمة |
| PUT | `/api/v1/work-packages/:id/services/:serviceId` | تحديث خدمة |
| DELETE | `/api/v1/work-packages/:id/services/:serviceId` | حذف خدمة |
| GET | `/api/v1/work-packages/:id/cost-summary` | ملخص التكلفة |
| GET | `/api/v1/projects/:id/cost-report` | تقرير تكلفة المشروع |

---

# 🔌 التكامل مع نظام المطور (02)

## نظرة عامة

نظام التخطيط والمشاريع يتكامل مع نظام المطور عبر:
1. **APIs الداخلية** - للتواصل مع الأنظمة الأخرى
2. **نظام الأحداث** - لنشر أحداث المشاريع
3. **التكامل مع الأصول** - لرسملة الأصول من المشاريع
4. **التكامل المالي** - لتتبع ميزانيات المشاريع

---

## 📡 APIs المسجلة في نظام المطور

جميع APIs نظام التخطيط والمشاريع متاحة عبر `/api/projects/*`:

| المجموعة | Endpoint | الوصف |
|----------|----------|-------|
| المشاريع | `/api/projects` | إدارة المشاريع |
| المهام | `/api/projects/:id/tasks` | مهام المشروع |
| الموارد | `/api/projects/:id/resources` | موارد المشروع |
| الميزانية | `/api/projects/:id/budget` | ميزانية المشروع |

---

## 🎯 الأحداث المنشورة

```
project.created             - إنشاء مشروع جديد
project.started             - بدء المشروع
project.completed           - إكمال المشروع
project.cancelled           - إلغاء المشروع

task.created                - إنشاء مهمة
task.assigned               - إسناد مهمة
task.completed              - إكمال مهمة
task.delayed                - تأخر مهمة

milestone.reached           - الوصول لمرحلة
budget.exceeded             - تجاوز الميزانية
```

---

## 📥 الأحداث المستقبلة

| الحدث | المصدر | الإجراء |
|-------|--------|---------|
| `asset.installed` | الأصول والصيانة | تحديث تقدم المشروع |
| `work_order.completed` | العمليات الميدانية | تحديث المهام |
| `inventory.material_issued` | المخزون | تحديث استهلاك المواد |
| `invoice.paid` | العملاء والفوترة | تحديث الإيرادات |

---

## 🔗 التكامل مع نظام الأصول

### رسملة الأصول من المشاريع

```
POST /api/projects/:id/assets/capitalize
```

```json
{
  "asset_type": "generator",
  "asset_details": {...},
  "installation_date": "2024-12-15",
  "cost": 50000
}
```

---

## 💰 التكامل المالي

### ربط الميزانية بشجرة الحسابات

```sql
-- ربط المشروع بمركز تكلفة
UPDATE projects
SET cost_center_id = 'uuid'
WHERE id = 'project_id';
```

### تتبع المصروفات

```
GET /api/projects/:id/expenses
POST /api/projects/:id/expenses
```

---

## 📊 مقاييس الأداء المرسلة لنظام المطور

```sql
INSERT INTO performance_metrics (metric_name, metric_type, metric_value, labels)
VALUES
  ('projects.active_count', 'gauge', 15, '{}'),
  ('projects.completion_rate', 'gauge', 85.5, '{}'),
  ('projects.delayed_count', 'gauge', 3, '{}'),
  ('projects.budget_utilization', 'gauge', 72.3, '{}');
```

---

## 🤖 تكامل الذكاء الاصطناعي

### التنبؤ بتأخر المشاريع

```
POST /api/ai/predict/project-delay
{
  "project_id": "uuid"
}
```

### تحسين توزيع الموارد

```
POST /api/ai/optimize/resource-allocation
{
  "project_ids": ["uuid1", "uuid2"],
  "resource_type": "team"
}
```


---

# 📊 إكمال نظام التخطيط والمشاريع

## جداول قاعدة البيانات الإضافية

### جدول الموارد

```sql
CREATE TABLE project_resources (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    business_id UUID REFERENCES businesses(id),
    
    -- نوع المورد
    resource_type VARCHAR(20) NOT NULL, -- employee, equipment, material, contractor
    
    -- المرجع
    employee_id UUID REFERENCES employees(id),
    equipment_id UUID REFERENCES assets(id),
    material_id UUID REFERENCES inventory_items(id),
    contractor_name VARCHAR(255),
    
    -- التكلفة
    hourly_rate DECIMAL(10, 2),
    daily_rate DECIMAL(10, 2),
    unit_cost DECIMAL(10, 2),
    
    -- التوفر
    availability_hours_per_day INT DEFAULT 8,
    availability_days_per_week INT DEFAULT 5,
    
    -- المهارات
    skills TEXT[],
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW()
);
```

### جدول تخصيص الموارد

```sql
CREATE TABLE resource_assignments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id),
    task_id UUID REFERENCES project_tasks(id),
    resource_id UUID REFERENCES project_resources(id),
    
    -- التخصيص
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    hours_per_day DECIMAL(4, 2) DEFAULT 8,
    allocation_percentage INT DEFAULT 100,
    
    -- التكلفة
    planned_hours DECIMAL(10, 2),
    actual_hours DECIMAL(10, 2) DEFAULT 0,
    planned_cost DECIMAL(15, 2),
    actual_cost DECIMAL(15, 2) DEFAULT 0,
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'planned', -- planned, active, completed
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### جدول المخاطر

```sql
CREATE TABLE project_risks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id),
    
    -- المخاطرة
    title VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(50), -- technical, financial, schedule, resource, external
    
    -- التقييم
    probability VARCHAR(20) NOT NULL, -- low, medium, high, very_high
    impact VARCHAR(20) NOT NULL, -- low, medium, high, critical
    risk_score INT, -- محسوب: probability * impact
    
    -- الاستجابة
    response_strategy VARCHAR(20), -- avoid, mitigate, transfer, accept
    mitigation_plan TEXT,
    contingency_plan TEXT,
    
    -- المسؤولية
    owner_id UUID REFERENCES users(id),
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'identified', -- identified, analyzing, mitigating, closed
    
    identified_date DATE DEFAULT CURRENT_DATE,
    review_date DATE,
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### جدول المشكلات

```sql
CREATE TABLE project_issues (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id),
    task_id UUID REFERENCES project_tasks(id),
    
    -- المشكلة
    title VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(50),
    
    -- الأولوية
    priority VARCHAR(20) NOT NULL, -- low, medium, high, critical
    
    -- المسؤولية
    reported_by UUID REFERENCES users(id),
    assigned_to UUID REFERENCES users(id),
    
    -- الحل
    resolution TEXT,
    resolved_at TIMESTAMP,
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'open', -- open, in_progress, resolved, closed
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

### جدول طلبات التغيير

```sql
CREATE TABLE change_requests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id),
    
    -- الطلب
    request_number VARCHAR(20) NOT NULL UNIQUE,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    justification TEXT,
    
    -- التأثير
    scope_impact TEXT,
    schedule_impact TEXT,
    cost_impact DECIMAL(15, 2),
    
    -- الموافقة
    requested_by UUID REFERENCES users(id),
    approved_by UUID REFERENCES users(id),
    approval_date TIMESTAMP,
    
    -- الحالة
    status VARCHAR(20) DEFAULT 'pending', -- pending, approved, rejected, implemented
    
    created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 📱 الشاشات والواجهات

### 1. لوحة تحكم المشاريع (Projects Dashboard)

| المكون | الوصف |
|--------|-------|
| ملخص المشاريع | عدد المشاريع حسب الحالة |
| مخطط جانت | عرض زمني للمشاريع النشطة |
| الميزانية | الميزانية مقابل الفعلي |
| المخاطر | المخاطر العالية |
| المهام المتأخرة | مهام تجاوزت الموعد |

### 2. شاشة إدارة المشروع (Project Management)

| المكون | الوصف |
|--------|-------|
| معلومات المشروع | البيانات الأساسية |
| مخطط جانت | المهام والجدول الزمني |
| الموارد | الموارد المخصصة |
| الميزانية | تتبع التكاليف |
| المخاطر | إدارة المخاطر |
| المستندات | ملفات المشروع |

### 3. شاشة إدارة المهام (Task Management)

| المكون | الوصف |
|--------|-------|
| قائمة المهام | جدول المهام |
| لوحة كانبان | عرض Kanban |
| تفاصيل المهمة | معلومات المهمة |
| التبعيات | علاقات المهام |

### 4. شاشة إدارة الموارد (Resource Management)

| المكون | الوصف |
|--------|-------|
| قائمة الموارد | الموارد المتاحة |
| تقويم الموارد | التخصيصات |
| تحميل الموارد | نسبة الاستخدام |
| التعارضات | تعارضات التخصيص |

### 5. شاشة إدارة الميزانية (Budget Management)

| المكون | الوصف |
|--------|-------|
| ملخص الميزانية | المخطط مقابل الفعلي |
| بنود التكلفة | تفصيل التكاليف |
| التدفق النقدي | الصرف الشهري |
| التنبؤات | التكلفة المتوقعة |

### 6. شاشة التقارير (Project Reports)

| المكون | الوصف |
|--------|-------|
| تقرير الحالة | ملخص حالة المشروع |
| تقرير التقدم | نسبة الإنجاز |
| تقرير التكاليف | تحليل التكاليف |
| تقرير المخاطر | حالة المخاطر |

---

## ⚙️ قواعد العمل

### قواعد المشاريع

| القاعدة | الوصف |
|---------|-------|
| BR-PRJ-001 | المشروع يتطلب موافقة للبدء |
| BR-PRJ-002 | لا يمكن إغلاق مشروع بمهام مفتوحة |
| BR-PRJ-003 | تجاوز الميزانية 10% يتطلب موافقة |
| BR-PRJ-004 | تأخر المشروع 20% يُنشئ تنبيه |

### قواعد المهام

| القاعدة | الوصف |
|---------|-------|
| BR-TSK-001 | المهمة تتطلب تاريخ بداية ونهاية |
| BR-TSK-002 | لا يمكن بدء مهمة قبل اكتمال التبعيات |
| BR-TSK-003 | تحديث التقدم أسبوعياً على الأقل |
| BR-TSK-004 | المهمة المتأخرة تُنشئ إشعار |

### قواعد الموارد

| القاعدة | الوصف |
|---------|-------|
| BR-RES-001 | لا يمكن تخصيص مورد أكثر من 100% |
| BR-RES-002 | التخصيص يتطلب موافقة المدير |
| BR-RES-003 | تعارض التخصيص يُنشئ تنبيه |

---

## 🔐 قواعد التحقق

```sql
-- التحقق من تخصيص الموارد
CREATE OR REPLACE FUNCTION validate_resource_assignment()
RETURNS TRIGGER AS $$
DECLARE
    total_allocation INT;
BEGIN
    -- حساب إجمالي التخصيص للمورد في الفترة
    SELECT COALESCE(SUM(allocation_percentage), 0) INTO total_allocation
    FROM resource_assignments
    WHERE resource_id = NEW.resource_id
    AND status IN ('planned', 'active')
    AND (start_date, end_date) OVERLAPS (NEW.start_date, NEW.end_date)
    AND id != COALESCE(NEW.id, '00000000-0000-0000-0000-000000000000');
    
    IF total_allocation + NEW.allocation_percentage > 100 THEN
        RAISE EXCEPTION 'تجاوز الحد الأقصى لتخصيص المورد. المتاح: %', 100 - total_allocation;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER check_resource_allocation
BEFORE INSERT OR UPDATE ON resource_assignments
FOR EACH ROW EXECUTE FUNCTION validate_resource_assignment();
```

---

## 📡 APIs إضافية

```
# إدارة المشاريع
GET    /api/projects                         - قائمة المشاريع
GET    /api/projects/:id                     - تفاصيل مشروع
POST   /api/projects                         - إنشاء مشروع
PUT    /api/projects/:id                     - تعديل مشروع
DELETE /api/projects/:id                     - حذف مشروع
GET    /api/projects/:id/gantt               - مخطط جانت
GET    /api/projects/:id/dashboard           - لوحة تحكم المشروع

# إدارة المهام
GET    /api/projects/:id/tasks               - قائمة المهام
POST   /api/projects/:id/tasks               - إنشاء مهمة
PUT    /api/tasks/:id                        - تعديل مهمة
PUT    /api/tasks/:id/progress               - تحديث التقدم
GET    /api/tasks/:id/dependencies           - تبعيات المهمة

# إدارة الموارد
GET    /api/resources                        - قائمة الموارد
POST   /api/resources                        - إضافة مورد
GET    /api/resources/:id/assignments        - تخصيصات المورد
POST   /api/projects/:id/assignments         - تخصيص مورد
GET    /api/resources/availability           - توفر الموارد

# إدارة الميزانية
GET    /api/projects/:id/budget              - ميزانية المشروع
POST   /api/projects/:id/budget/items        - إضافة بند
PUT    /api/projects/:id/budget/items/:id    - تعديل بند
GET    /api/projects/:id/costs               - التكاليف الفعلية

# إدارة المخاطر
GET    /api/projects/:id/risks               - قائمة المخاطر
POST   /api/projects/:id/risks               - إضافة مخاطرة
PUT    /api/risks/:id                        - تعديل مخاطرة

# إدارة المشكلات
GET    /api/projects/:id/issues              - قائمة المشكلات
POST   /api/projects/:id/issues              - إضافة مشكلة
PUT    /api/issues/:id                       - تعديل مشكلة

# طلبات التغيير
GET    /api/projects/:id/change-requests     - طلبات التغيير
POST   /api/projects/:id/change-requests     - طلب تغيير
PUT    /api/change-requests/:id/approve      - موافقة
PUT    /api/change-requests/:id/reject       - رفض

# التقارير
GET    /api/projects/:id/reports/status      - تقرير الحالة
GET    /api/projects/:id/reports/progress    - تقرير التقدم
GET    /api/projects/:id/reports/costs       - تقرير التكاليف
```


---

## 🛠️ البنية التقنية للنظام

### معلومات المستودع

| العنصر | القيمة |
|--------|--------|
| **اسم المستودع** | `projects-system` |
| **المنفذ API** | 3010 |
| **المنفذ Web** | 4210 |
| **بادئة الجداول** | `proj_` |
| **مسار API** | `/api/v1/projects` |

### Prisma Schema الأساسي

```prisma
model proj_projects {
  id              String    @id @default(uuid()) @db.Uuid
  code            String    @unique @db.VarChar(50)
  name            String    @db.VarChar(200)
  description     String?   @db.Text
  type            String    @db.VarChar(50)
  status          String    @default("planning") @db.VarChar(20)
  priority        String    @default("medium") @db.VarChar(20)
  managerId       String?   @map("manager_id") @db.Uuid
  stationId       String?   @map("station_id") @db.Uuid
  startDate       DateTime? @map("start_date") @db.Date
  endDate         DateTime? @map("end_date") @db.Date
  actualStartDate DateTime? @map("actual_start_date") @db.Date
  actualEndDate   DateTime? @map("actual_end_date") @db.Date
  progress        Int       @default(0)
  budgetAmount    Decimal   @default(0) @map("budget_amount") @db.Decimal(15, 2)
  actualCost      Decimal   @default(0) @map("actual_cost") @db.Decimal(15, 2)
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  tasks           proj_tasks[]
  budgets         proj_budgets[]
  resources       proj_resources[]
  
  @@index([status])
  @@index([stationId])
  @@map("proj_projects")
}

model proj_tasks {
  id              String    @id @default(uuid()) @db.Uuid
  projectId       String    @map("project_id") @db.Uuid
  parentId        String?   @map("parent_id") @db.Uuid
  code            String    @db.VarChar(50)
  name            String    @db.VarChar(200)
  description     String?   @db.Text
  status          String    @default("pending") @db.VarChar(20)
  priority        String    @default("medium") @db.VarChar(20)
  assignedTo      String?   @map("assigned_to") @db.Uuid
  startDate       DateTime? @map("start_date") @db.Date
  endDate         DateTime? @map("end_date") @db.Date
  actualStartDate DateTime? @map("actual_start_date") @db.Date
  actualEndDate   DateTime? @map("actual_end_date") @db.Date
  estimatedHours  Decimal?  @map("estimated_hours") @db.Decimal(10, 2)
  actualHours     Decimal?  @map("actual_hours") @db.Decimal(10, 2)
  progress        Int       @default(0)
  sortOrder       Int       @default(0) @map("sort_order")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  project         proj_projects @relation(fields: [projectId], references: [id])
  parent          proj_tasks?   @relation("TaskHierarchy", fields: [parentId], references: [id])
  children        proj_tasks[]  @relation("TaskHierarchy")
  dependencies    proj_task_dependencies[] @relation("DependentTask")
  dependents      proj_task_dependencies[] @relation("PredecessorTask")
  
  @@unique([projectId, code])
  @@map("proj_tasks")
}

model proj_task_dependencies {
  id              String   @id @default(uuid()) @db.Uuid
  taskId          String   @map("task_id") @db.Uuid
  predecessorId   String   @map("predecessor_id") @db.Uuid
  type            String   @default("finish_to_start") @db.VarChar(20)
  lagDays         Int      @default(0) @map("lag_days")
  
  task            proj_tasks @relation("DependentTask", fields: [taskId], references: [id])
  predecessor     proj_tasks @relation("PredecessorTask", fields: [predecessorId], references: [id])
  
  @@unique([taskId, predecessorId])
  @@map("proj_task_dependencies")
}

model proj_budgets {
  id            String   @id @default(uuid()) @db.Uuid
  projectId     String   @map("project_id") @db.Uuid
  category      String   @db.VarChar(50)
  description   String?  @db.VarChar(200)
  budgetAmount  Decimal  @map("budget_amount") @db.Decimal(15, 2)
  actualAmount  Decimal  @default(0) @map("actual_amount") @db.Decimal(15, 2)
  variance      Decimal  @default(0) @db.Decimal(15, 2)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  project       proj_projects @relation(fields: [projectId], references: [id])
  
  @@map("proj_budgets")
}

model proj_resources {
  id            String    @id @default(uuid()) @db.Uuid
  projectId     String    @map("project_id") @db.Uuid
  resourceType  String    @map("resource_type") @db.VarChar(20)
  resourceId    String    @map("resource_id") @db.Uuid
  role          String?   @db.VarChar(100)
  allocation    Int       @default(100)
  startDate     DateTime? @map("start_date") @db.Date
  endDate       DateTime? @map("end_date") @db.Date
  hourlyRate    Decimal?  @map("hourly_rate") @db.Decimal(10, 2)
  createdAt     DateTime  @default(now()) @map("created_at")
  
  project       proj_projects @relation(fields: [projectId], references: [id])
  
  @@map("proj_resources")
}

model proj_milestones {
  id            String    @id @default(uuid()) @db.Uuid
  projectId     String    @map("project_id") @db.Uuid
  name          String    @db.VarChar(200)
  description   String?   @db.Text
  dueDate       DateTime  @map("due_date") @db.Date
  completedDate DateTime? @map("completed_date") @db.Date
  status        String    @default("pending") @db.VarChar(20)
  createdAt     DateTime  @default(now()) @map("created_at")
  
  @@map("proj_milestones")
}

model proj_capitalizations {
  id              String    @id @default(uuid()) @db.Uuid
  projectId       String    @map("project_id") @db.Uuid
  assetId         String?   @map("asset_id") @db.Uuid
  amount          Decimal   @db.Decimal(15, 2)
  capitalizedDate DateTime  @map("capitalized_date") @db.Date
  journalEntryId  String?   @map("journal_entry_id") @db.Uuid
  notes           String?   @db.Text
  createdBy       String    @map("created_by") @db.Uuid
  createdAt       DateTime  @default(now()) @map("created_at")
  
  @@map("proj_capitalizations")
}
```

### Environment Variables

```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/electricity_management"
JWT_SECRET="projects-system-secret-key"
API_PORT=3010
CORE_API_URL="http://localhost:3001/api/v1"
ASSETS_API_URL="http://localhost:3003/api/v1"
HR_API_URL="http://localhost:3008/api/v1"
```
