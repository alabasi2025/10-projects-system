<div class="gantt-container">
  <!-- Header -->
  <div class="gantt-header">
    <div class="header-right">
      <button class="btn-back" (click)="goBack()">
        â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
      </button>
      <h1>Ù…Ø®Ø·Ø· Ø¬Ø§Ù†Øª</h1>
    </div>
    <div class="header-left">
      <div class="zoom-controls">
        <span>Ø§Ù„ØªÙƒØ¨ÙŠØ±:</span>
        <button
          [class.active]="zoomLevel() === 'day'"
          (click)="setZoomLevel('day')"
        >
          ÙŠÙˆÙ…
        </button>
        <button
          [class.active]="zoomLevel() === 'week'"
          (click)="setZoomLevel('week')"
        >
          Ø£Ø³Ø¨ÙˆØ¹
        </button>
        <button
          [class.active]="zoomLevel() === 'month'"
          (click)="setZoomLevel('month')"
        >
          Ø´Ù‡Ø±
        </button>
      </div>
      <button
        class="btn-critical"
        [class.active]="showCriticalPath()"
        (click)="toggleCriticalPath()"
      >
        {{ showCriticalPath() ? 'ğŸ”´ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø±Ø¬' : 'âšª Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø±Ø¬' }}
      </button>
      <button class="btn-refresh" (click)="refresh()">
        ğŸ”„ ØªØ­Ø¯ÙŠØ«
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø®Ø·Ø· Ø¬Ø§Ù†Øª...</p>
    </div>
  }

  <!-- Error State -->
  @if (error()) {
    <div class="error-container">
      <span class="error-icon">âš ï¸</span>
      <p>{{ error() }}</p>
      <button (click)="refresh()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
    </div>
  }

  <!-- Empty State -->
  @if (!loading() && !error() && tasks().length === 0) {
    <div class="empty-container">
      <span class="empty-icon">ğŸ“Š</span>
      <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</h3>
      <p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø±Ø§Ø­Ù„ Ø£Ùˆ Ø­Ø²Ù… Ø¹Ù…Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</p>
      <button (click)="goBack()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</button>
    </div>
  }

  <!-- Gantt Chart -->
  @if (!loading() && !error() && tasks().length > 0) {
    <!-- Project Info -->
    <div class="project-info">
      @if (criticalPath()) {
        <div class="info-card">
          <span class="info-label">Ù…Ø¯Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</span>
          <span class="info-value">{{ projectDuration() }} ÙŠÙˆÙ…</span>
        </div>
        <div class="info-card">
          <span class="info-label">Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø­Ø±Ø¬Ø©</span>
          <span class="info-value">{{ criticalTasks().length }}</span>
        </div>
        <div class="info-card">
          <span class="info-label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</span>
          <span class="info-value">{{ criticalPath()?.projectEndDate | date:'yyyy/MM/dd' }}</span>
        </div>
      }
    </div>

    <div class="gantt-wrapper">
      <!-- Task List (Left Panel) -->
      <div class="task-list">
        <div class="task-list-header">
          <span>Ø§Ù„Ù…Ù‡Ù…Ø©</span>
          <span>Ø§Ù„ØªÙ‚Ø¯Ù…</span>
        </div>
        @for (task of tasks(); track task.id) {
          <div
            class="task-row"
            [class.selected]="selectedTask()?.id === task.id"
            [class.critical]="showCriticalPath() && criticalTasks().includes(task.id)"
            [style.padding-right.px]="getTaskIndent(task) + 10"
            (click)="selectTask(task)"
          >
            <div class="task-name">
              <span class="task-icon">{{ getTaskIcon(task) }}</span>
              <span class="task-text">{{ task.text }}</span>
            </div>
            <div class="task-progress">
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  [style.width.%]="task.progress * 100"
                  [style.background-color]="getTaskColor(task)"
                ></div>
              </div>
              <span class="progress-text">{{ (task.progress * 100).toFixed(0) }}%</span>
            </div>
          </div>
        }
      </div>

      <!-- Timeline (Right Panel) -->
      <div class="timeline-container" #ganttContainer>
        <!-- Timeline Header -->
        <div class="timeline-header">
          <!-- Months Row -->
          <div class="months-row">
            @for (month of getTimelineMonths(); track month.month + '-' + month.year) {
              <div
                class="month-cell"
                [style.width.px]="month.days * dayWidth()"
              >
                {{ getMonthName(month.month) }} {{ month.year }}
              </div>
            }
          </div>
          <!-- Days Row -->
          <div class="days-row">
            @for (day of getTimelineDays(); track day.toISOString()) {
              <div
                class="day-cell"
                [class.weekend]="isWeekend(day)"
                [class.today]="isToday(day)"
                [style.width.px]="dayWidth()"
              >
                <span class="day-number">{{ day.getDate() }}</span>
                @if (zoomLevel() === 'day') {
                  <span class="day-name">{{ getDayName(day) }}</span>
                }
              </div>
            }
          </div>
        </div>

        <!-- Timeline Body -->
        <div class="timeline-body">
          <!-- Grid Lines -->
          <div class="grid-lines">
            @for (day of getTimelineDays(); track day.toISOString()) {
              <div
                class="grid-line"
                [class.weekend]="isWeekend(day)"
                [class.today]="isToday(day)"
                [style.width.px]="dayWidth()"
              ></div>
            }
          </div>

          <!-- Task Bars -->
          @for (task of tasks(); track task.id; let i = $index) {
            <div
              class="task-bar-row"
              [style.height.px]="rowHeight"
            >
              <div
                class="task-bar"
                [class.critical]="showCriticalPath() && criticalTasks().includes(task.id)"
                [style.left.px]="getTaskLeft(task)"
                [style.width.px]="getTaskWidth(task)"
                [style.background-color]="getTaskColor(task)"
                (click)="selectTask(task)"
              >
                <div
                  class="task-bar-progress"
                  [style.width.px]="getProgressWidth(task)"
                ></div>
                <span class="task-bar-text">{{ task.text }}</span>
              </div>
            </div>
          }

          <!-- Today Line -->
          <div class="today-line-container">
            <!-- Ø®Ø· Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙŠØªÙ… Ø±Ø³Ù…Ù‡ ÙÙŠ CSS -->
          </div>
        </div>
      </div>
    </div>

    <!-- Task Details Panel -->
    @if (selectedTask()) {
      <div class="task-details">
        <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©</h3>
        <div class="details-grid">
          <div class="detail-item">
            <label>Ø§Ù„Ø§Ø³Ù…:</label>
            <span>{{ selectedTask()?.text }}</span>
          </div>
          <div class="detail-item">
            <label>Ø§Ù„Ù†ÙˆØ¹:</label>
            <span>
              @switch (selectedTask()?.type) {
                @case ('project') { Ù…Ø´Ø±ÙˆØ¹ }
                @case ('phase') { Ù…Ø±Ø­Ù„Ø© }
                @case ('work_package') { Ø­Ø²Ù…Ø© Ø¹Ù…Ù„ }
              }
            </span>
          </div>
          <div class="detail-item">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡:</label>
            <span>{{ selectedTask()?.start_date | date:'yyyy/MM/dd' }}</span>
          </div>
          <div class="detail-item">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</label>
            <span>{{ selectedTask()?.end_date | date:'yyyy/MM/dd' }}</span>
          </div>
          <div class="detail-item">
            <label>Ø§Ù„Ù…Ø¯Ø©:</label>
            <span>{{ selectedTask()?.duration }} ÙŠÙˆÙ…</span>
          </div>
          <div class="detail-item">
            <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²:</label>
            <span>{{ ((selectedTask()?.progress || 0) * 100).toFixed(0) }}%</span>
          </div>
          @if (showCriticalPath() && selectedTask()) {
            <div class="detail-item">
              <label>Ø§Ù„ÙØ§Ø¦Ø¶ (Slack):</label>
              <span>{{ getSlack(selectedTask()!.id) }} ÙŠÙˆÙ…</span>
            </div>
            <div class="detail-item">
              <label>Ù…Ù‡Ù…Ø© Ø­Ø±Ø¬Ø©:</label>
              <span [class.critical-badge]="criticalTasks().includes(selectedTask()!.id)">
                {{ criticalTasks().includes(selectedTask()!.id) ? 'Ù†Ø¹Ù…' : 'Ù„Ø§' }}
              </span>
            </div>
          }
        </div>
      </div>
    }

    <!-- Legend -->
    <div class="legend">
      <div class="legend-item">
        <span class="legend-color project"></span>
        <span>Ù…Ø´Ø±ÙˆØ¹</span>
      </div>
      <div class="legend-item">
        <span class="legend-color phase"></span>
        <span>Ù…Ø±Ø­Ù„Ø©</span>
      </div>
      <div class="legend-item">
        <span class="legend-color work-package"></span>
        <span>Ø­Ø²Ù…Ø© Ø¹Ù…Ù„</span>
      </div>
      @if (showCriticalPath()) {
        <div class="legend-item">
          <span class="legend-color critical"></span>
          <span>Ù…Ù‡Ù…Ø© Ø­Ø±Ø¬Ø©</span>
        </div>
      }
      <div class="legend-item">
        <span class="legend-color today"></span>
        <span>Ø§Ù„ÙŠÙˆÙ…</span>
      </div>
      <div class="legend-item">
        <span class="legend-color weekend"></span>
        <span>Ø¹Ø·Ù„Ø© Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</span>
      </div>
    </div>
  }
</div>
