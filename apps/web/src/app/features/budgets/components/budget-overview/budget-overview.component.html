<div class="budget-container" dir="rtl">
  <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
  <div class="page-header">
    <div class="header-content">
      <button class="back-btn" (click)="goBack()">
        <span class="arrow">â†</span>
        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
      </button>
      <div class="title-section">
        <h1>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h1>
        @if (project) {
          <p class="project-info">
            <span class="project-number">{{ project.projectNumber }}</span>
            <span class="separator">|</span>
            <span class="project-name">{{ project.name }}</span>
          </p>
        }
      </div>
    </div>
    <div class="header-actions">
      <button class="wbs-btn" (click)="goToWbs()">
        ğŸ“ ØªØ¬Ø²Ø¦Ø© Ø§Ù„Ø¹Ù…Ù„
      </button>
      <button class="add-expense-btn" (click)="openExpenseForm()">
        <span class="icon">+</span>
        Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ
      </button>
    </div>
  </div>

  <!-- Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
  @if (loading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©...</p>
    </div>
  }

  <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ -->
  @if (error) {
    <div class="error-state">
      <p>{{ error }}</p>
      <button (click)="loadProjectData(project?.id || '')">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
    </div>
  }

  @if (!loading && !error) {
    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© -->
    @if (!budget) {
      <div class="no-budget-card">
        <div class="no-budget-icon">ğŸ’°</div>
        <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h3>
        <p>Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯</p>
        <button class="create-budget-btn" (click)="createBudget()">
          Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙŠØ²Ø§Ù†ÙŠØ©
        </button>
      </div>
    } @else {
      <!-- Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© -->
      <div class="budget-overview">
        <div class="budget-card main">
          <div class="budget-header">
            <h2>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h2>
            <span class="budget-version">Ø§Ù„Ø¥ØµØ¯Ø§Ø± {{ budget.budgetVersion }}</span>
          </div>
          
          <div class="budget-stats">
            <div class="stat-item">
              <span class="stat-label">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©</span>
              <span class="stat-value original">{{ formatCurrency(budget.originalBudget) }} Ø±.Ø³</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</span>
              <span class="stat-value adjustments" [class.positive]="budget.adjustments > 0" [class.negative]="budget.adjustments < 0">
                {{ budget.adjustments >= 0 ? '+' : '' }}{{ formatCurrency(budget.adjustments) }} Ø±.Ø³
              </span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>
              <span class="stat-value current">{{ formatCurrency(budget.currentBudget) }} Ø±.Ø³</span>
            </div>
          </div>

          <div class="budget-progress">
            <div class="progress-row">
              <div class="progress-info">
                <span class="progress-label">Ø§Ù„Ù…ØµØ±ÙˆÙ</span>
                <span class="progress-value">{{ formatCurrency(budget.spentAmount) }} Ø±.Ø³ ({{ spentPercentage }}%)</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill spent" [style.width.%]="spentPercentage"></div>
              </div>
            </div>
            <div class="progress-row">
              <div class="progress-info">
                <span class="progress-label">Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</span>
                <span class="progress-value">{{ formatCurrency(budget.committedAmount) }} Ø±.Ø³ ({{ committedPercentage }}%)</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill committed" [style.width.%]="committedPercentage"></div>
              </div>
            </div>
          </div>

          <div class="budget-remaining">
            <span class="remaining-label">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</span>
            <span class="remaining-value" [class.warning]="spentPercentage > 80" [class.danger]="spentPercentage > 95">
              {{ formatCurrency(budget.remainingBudget) }} Ø±.Ø³
            </span>
          </div>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ -->
        @if (expenseStatistics) {
          <div class="budget-card expenses-summary">
            <h3>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h3>
            <div class="expense-types">
              @for (type of expenseTypes; track type.value) {
                <div class="expense-type-item">
                  <div class="type-color" [style.background-color]="getExpenseTypeColor(type.value)"></div>
                  <span class="type-label">{{ type.label }}</span>
                  <span class="type-amount">
                    {{ formatCurrency(expenseStatistics.byType[type.value]?.amount || 0) }} Ø±.Ø³
                  </span>
                  <span class="type-count">
                    ({{ expenseStatistics.byType[type.value]?.count || 0 }})
                  </span>
                </div>
              }
            </div>
            <div class="total-expenses">
              <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª:</span>
              <strong>{{ formatCurrency(expenseStatistics.totalAmount) }} Ø±.Ø³</strong>
            </div>
          </div>
        }
      </div>

      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª -->
      <div class="expenses-section">
        <div class="section-header">
          <h2>Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>
          <span class="expenses-count">{{ expenses.length }} Ù…ØµØ±ÙˆÙ</span>
        </div>

        @if (expenses.length === 0) {
          <div class="empty-expenses">
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³Ø¬Ù„Ø©</p>
            <button class="add-btn" (click)="openExpenseForm()">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
          </div>
        } @else {
          <div class="expenses-table">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ù†ÙˆØ¹</th>
                  <th>Ø§Ù„ÙˆØµÙ</th>
                  <th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th>
                  <th>Ø­Ø²Ù…Ø© Ø§Ù„Ø¹Ù…Ù„</th>
                  <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody>
                @for (expense of expenses; track expense.id) {
                  <tr>
                    <td>{{ formatDate(expense.expenseDate) }}</td>
                    <td>
                      <span class="expense-type-badge" [style.background-color]="getExpenseTypeColor(expense.expenseType)">
                        {{ getExpenseTypeLabel(expense.expenseType) }}
                      </span>
                    </td>
                    <td>{{ expense.description || '-' }}</td>
                    <td>{{ expense.phase?.name || '-' }}</td>
                    <td>{{ expense.workPackage?.name || '-' }}</td>
                    <td class="amount-cell">{{ formatCurrency(expense.amount) }} Ø±.Ø³</td>
                    <td>
                      <button class="delete-btn" (click)="deleteExpense(expense)" title="Ø­Ø°Ù">
                        ğŸ—‘
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    }
  }

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ -->
  @if (showExpenseForm) {
    <div class="modal-overlay" (click)="closeExpenseForm()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h2>
          <button class="close-btn" (click)="closeExpenseForm()">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ *</label>
              <select [(ngModel)]="expenseForm.expenseType">
                @for (type of expenseTypes; track type.value) {
                  <option [value]="type.value">{{ type.label }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØµØ±ÙˆÙ *</label>
              <input type="date" [(ngModel)]="expenseForm.expenseDate" />
            </div>
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø±.Ø³) *</label>
            <input type="number" [(ngModel)]="expenseForm.amount" min="0" placeholder="0" />
          </div>
          <div class="form-group">
            <label>Ø§Ù„ÙˆØµÙ</label>
            <textarea [(ngModel)]="expenseForm.description" rows="3" placeholder="ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <select [(ngModel)]="expenseForm.phaseId" (ngModelChange)="onPhaseChange()">
                <option [value]="undefined">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© --</option>
                @for (phase of phases; track phase.id) {
                  <option [value]="phase.id">{{ phase.phaseNumber }}. {{ phase.name }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Ø­Ø²Ù…Ø© Ø§Ù„Ø¹Ù…Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <select [(ngModel)]="expenseForm.workPackageId" [disabled]="!expenseForm.phaseId">
                <option [value]="undefined">-- Ø§Ø®ØªØ± Ø­Ø²Ù…Ø© Ø§Ù„Ø¹Ù…Ù„ --</option>
                @for (wp of workPackages; track wp.id) {
                  <option [value]="wp.id">{{ wp.packageNumber }} - {{ wp.name }}</option>
                }
              </select>
            </div>
          </div>
          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" [(ngModel)]="expenseForm.createJournalEntry" />
              Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ Ù…Ø­Ø§Ø³Ø¨ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" (click)="closeExpenseForm()">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="save-btn" (click)="saveExpense()">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
        </div>
      </div>
    </div>
  }
</div>
