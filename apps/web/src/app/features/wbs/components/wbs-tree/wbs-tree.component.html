<div class="wbs-container" dir="rtl">
  <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
  <div class="page-header">
    <div class="header-content">
      <button class="back-btn" (click)="goBack()">
        <span class="arrow">â†</span>
        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
      </button>
      <div class="title-section">
        <h1>ØªØ¬Ø²Ø¦Ø© Ø§Ù„Ø¹Ù…Ù„ (WBS)</h1>
        @if (project) {
          <p class="project-info">
            <span class="project-number">{{ project.projectNumber }}</span>
            <span class="separator">|</span>
            <span class="project-name">{{ project.name }}</span>
          </p>
        }
      </div>
    </div>
    <button class="add-phase-btn" (click)="openPhaseForm()">
      <span class="icon">+</span>
      Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©
    </button>
  </div>

  <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
  @if (statistics) {
    <div class="statistics-grid">
      <div class="stat-card">
        <div class="stat-icon phases">ğŸ“‹</div>
        <div class="stat-content">
          <span class="stat-value">{{ statistics.total }}</span>
          <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon progress">ğŸ“Š</div>
        <div class="stat-content">
          <span class="stat-value">{{ statistics.averageProgress | number:'1.0-0' }}%</span>
          <span class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon budget">ğŸ’°</div>
        <div class="stat-content">
          <span class="stat-value">{{ formatCurrency(statistics.budget.totalAllocated) }}</span>
          <span class="stat-label">Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon spent">ğŸ’¸</div>
        <div class="stat-content">
          <span class="stat-value">{{ formatCurrency(statistics.budget.totalSpent) }}</span>
          <span class="stat-label">Ø§Ù„Ù…ØµØ±ÙˆÙ</span>
        </div>
      </div>
    </div>
  }

  <!-- Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
  @if (loading) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØªØ¬Ø²Ø¦Ø© Ø§Ù„Ø¹Ù…Ù„...</p>
    </div>
  }

  <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ -->
  @if (error) {
    <div class="error-state">
      <p>{{ error }}</p>
      <button (click)="loadProjectData(project?.id || '')">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
    </div>
  }

  <!-- Ø´Ø¬Ø±Ø© WBS -->
  @if (!loading && !error) {
    <div class="wbs-tree">
      @if (phases.length === 0) {
        <div class="empty-state">
          <div class="empty-icon">ğŸ“</div>
          <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ø­Ù„</h3>
          <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹</p>
          <button class="add-btn" (click)="openPhaseForm()">Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø©</button>
        </div>
      } @else {
        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø§Ø­Ù„ -->
        @for (phase of phases; track phase.id) {
          <div class="phase-item" [class.expanded]="isPhaseExpanded(phase.id)" [class.selected]="isSelected('phase', phase.id)">
            <!-- Ø±Ø£Ø³ Ø§Ù„Ù…Ø±Ø­Ù„Ø© -->
            <div class="phase-header" (click)="selectItem('phase', phase.id)">
              <button class="expand-btn" (click)="togglePhase(phase.id); $event.stopPropagation()">
                {{ isPhaseExpanded(phase.id) ? 'â–¼' : 'â—€' }}
              </button>
              <div class="phase-number">{{ phase.phaseNumber }}</div>
              <div class="phase-info">
                <h3 class="phase-name">{{ phase.name }}</h3>
                <p class="phase-dates">
                  {{ formatDate(phase.plannedStartDate) }} - {{ formatDate(phase.plannedEndDate) }}
                </p>
              </div>
              <div class="phase-status" [style.background-color]="getStatusColor(phase.status)">
                {{ getStatusLabel(phase.status) }}
              </div>
              <div class="phase-progress">
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="phase.progressPercent"></div>
                </div>
                <span class="progress-text">{{ phase.progressPercent }}%</span>
              </div>
              <div class="phase-budget">
                <span class="budget-allocated">{{ formatCurrency(phase.allocatedBudget) }}</span>
                <span class="budget-spent">{{ formatCurrency(phase.spentAmount) }} Ù…ØµØ±ÙˆÙ</span>
              </div>
              <div class="phase-actions">
                <button class="action-btn add" (click)="openWorkPackageForm(phase.id); $event.stopPropagation()" title="Ø¥Ø¶Ø§ÙØ© Ø­Ø²Ù…Ø© Ø¹Ù…Ù„">
                  +
                </button>
                <button class="action-btn delete" (click)="deletePhase(phase); $event.stopPropagation()" title="Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø­Ù„Ø©">
                  ğŸ—‘
                </button>
              </div>
            </div>

            <!-- Ø­Ø²Ù… Ø§Ù„Ø¹Ù…Ù„ -->
            @if (isPhaseExpanded(phase.id)) {
              <div class="work-packages">
                @if (!phase.workPackages || phase.workPackages.length === 0) {
                  <div class="empty-wp">
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ø¹Ù…Ù„</p>
                    <button class="add-wp-btn" (click)="openWorkPackageForm(phase.id)">
                      Ø¥Ø¶Ø§ÙØ© Ø­Ø²Ù…Ø© Ø¹Ù…Ù„
                    </button>
                  </div>
                } @else {
                  @for (wp of phase.workPackages; track wp.id) {
                    <div class="wp-item" [class.selected]="isSelected('work-package', wp.id)" (click)="selectItem('work-package', wp.id)">
                      <div class="wp-number">{{ wp.packageNumber }}</div>
                      <div class="wp-info">
                        <h4 class="wp-name">{{ wp.name }}</h4>
                        <p class="wp-dates">
                          {{ formatDate(wp.plannedStartDate) }} - {{ formatDate(wp.plannedEndDate) }}
                        </p>
                      </div>
                      <div class="wp-status" [style.background-color]="getStatusColor(wp.status)">
                        {{ getStatusLabel(wp.status) }}
                      </div>
                      <div class="wp-progress">
                        <div class="progress-bar">
                          <div class="progress-fill" [style.width.%]="wp.progressPercent"></div>
                        </div>
                        <span class="progress-text">{{ wp.progressPercent }}%</span>
                      </div>
                      <div class="wp-cost">
                        <span class="cost-estimated">{{ formatCurrency(wp.estimatedCost) }}</span>
                        <span class="cost-actual">{{ formatCurrency(wp.actualCost) }} ÙØ¹Ù„ÙŠ</span>
                      </div>
                      <div class="wp-actions">
                        <button class="action-btn delete" (click)="deleteWorkPackage(wp); $event.stopPropagation()" title="Ø­Ø°Ù Ø­Ø²Ù…Ø© Ø§Ù„Ø¹Ù…Ù„">
                          ğŸ—‘
                        </button>
                      </div>
                    </div>
                  }
                }
              </div>
            }
          </div>
        }
      }
    </div>
  }

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø© -->
  @if (showPhaseForm) {
    <div class="modal-overlay" (click)="closePhaseForm()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
          <button class="close-btn" (click)="closePhaseForm()">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø© *</label>
              <input type="number" [(ngModel)]="phaseForm.phaseNumber" min="1" />
            </div>
            <div class="form-group">
              <label>Ø§Ù„ØªØ±ØªÙŠØ¨</label>
              <input type="number" [(ngModel)]="phaseForm.sequenceOrder" min="1" />
            </div>
          </div>
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±Ø­Ù„Ø© *</label>
            <input type="text" [(ngModel)]="phaseForm.name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØµÙ…ÙŠÙ…" />
          </div>
          <div class="form-group">
            <label>Ø§Ù„ÙˆØµÙ</label>
            <textarea [(ngModel)]="phaseForm.description" rows="3" placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ø±Ø­Ù„Ø©..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø®Ø·Ø· *</label>
              <input type="date" [(ngModel)]="phaseForm.plannedStartDate" />
            </div>
            <div class="form-group">
              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø®Ø·Ø· *</label>
              <input type="date" [(ngModel)]="phaseForm.plannedEndDate" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ù…Ø®ØµØµØ©</label>
              <input type="number" [(ngModel)]="phaseForm.allocatedBudget" min="0" placeholder="0" />
            </div>
            <div class="form-group">
              <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
              <select [(ngModel)]="phaseForm.status">
                @for (status of phaseStatuses; track status.value) {
                  <option [value]="status.value">{{ status.label }}</option>
                }
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (%)</label>
            <input type="number" [(ngModel)]="phaseForm.progressPercent" min="0" max="100" />
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" (click)="closePhaseForm()">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="save-btn" (click)="savePhase()">Ø­ÙØ¸ Ø§Ù„Ù…Ø±Ø­Ù„Ø©</button>
        </div>
      </div>
    </div>
  }

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø­Ø²Ù…Ø© Ø¹Ù…Ù„ -->
  @if (showWorkPackageForm) {
    <div class="modal-overlay" (click)="closeWorkPackageForm()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Ø¥Ø¶Ø§ÙØ© Ø­Ø²Ù…Ø© Ø¹Ù…Ù„ Ø¬Ø¯ÙŠØ¯Ø©</h2>
          <button class="close-btn" (click)="closeWorkPackageForm()">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label>Ø±Ù‚Ù… Ø­Ø²Ù…Ø© Ø§Ù„Ø¹Ù…Ù„ *</label>
              <input type="text" [(ngModel)]="workPackageForm.packageNumber" placeholder="WP-01-001" />
            </div>
            <div class="form-group">
              <label>Ø§Ù„Ø­Ø§Ù„Ø©</label>
              <select [(ngModel)]="workPackageForm.status">
                @for (status of workPackageStatuses; track status.value) {
                  <option [value]="status.value">{{ status.label }}</option>
                }
              </select>
            </div>
          </div>
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø­Ø²Ù…Ø© Ø§Ù„Ø¹Ù…Ù„ *</label>
            <input type="text" [(ngModel)]="workPackageForm.name" placeholder="Ù…Ø«Ø§Ù„: Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ù‡Ù†Ø¯Ø³ÙŠØ©" />
          </div>
          <div class="form-group">
            <label>Ø§Ù„ÙˆØµÙ</label>
            <textarea [(ngModel)]="workPackageForm.description" rows="3" placeholder="ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ø¹Ù…Ù„..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø®Ø·Ø· *</label>
              <input type="date" [(ngModel)]="workPackageForm.plannedStartDate" />
            </div>
            <div class="form-group">
              <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø®Ø·Ø· *</label>
              <input type="date" [(ngModel)]="workPackageForm.plannedEndDate" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©</label>
              <input type="number" [(ngModel)]="workPackageForm.estimatedCost" min="0" placeholder="0" />
            </div>
            <div class="form-group">
              <label>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² (%)</label>
              <input type="number" [(ngModel)]="workPackageForm.progressPercent" min="0" max="100" />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="cancel-btn" (click)="closeWorkPackageForm()">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="save-btn" (click)="saveWorkPackage()">Ø­ÙØ¸ Ø­Ø²Ù…Ø© Ø§Ù„Ø¹Ù…Ù„</button>
        </div>
      </div>
    </div>
  }
</div>
